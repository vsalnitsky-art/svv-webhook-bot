{% extends "base.html" %}
{% block title %}Dashboard - Sleeper OB Bot{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="page-header">
        <h1>Dashboard</h1>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="runFullScan()">üîç Full Scan</button>
            <button class="btn btn-secondary" onclick="refreshStats()">üîÑ Refresh</button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üí∞</div>
            <div class="stat-content">
                <div class="stat-value" id="balance">
                    {% if paper_trading %}
                        ${{ "%.2f"|format(paper_balance) }}
                    {% else %}
                        ---
                    {% endif %}
                </div>
                <div class="stat-label">{{ 'Paper Balance' if paper_trading else 'Live Balance' }}</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
                <div class="stat-value">{{ trade_stats.total_trades }}</div>
                <div class="stat-label">Total Trades (30d)</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üéØ</div>
            <div class="stat-content">
                <div class="stat-value {% if trade_stats.win_rate >= 50 %}positive{% else %}negative{% endif %}">
                    {{ "%.1f"|format(trade_stats.win_rate) }}%
                </div>
                <div class="stat-label">Win Rate</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üíµ</div>
            <div class="stat-content">
                <div class="stat-value {% if trade_stats.total_pnl >= 0 %}positive{% else %}negative{% endif %}">
                    ${{ "%.2f"|format(trade_stats.total_pnl) }}
                </div>
                <div class="stat-label">Total P&L</div>
            </div>
        </div>
    </div>

    <!-- Live Activity Feed -->
    <div class="section activity-section">
        <div class="section-header">
            <h2>üì° Live Activity</h2>
            <span class="live-indicator" id="live-status">üî¥ Offline</span>
        </div>
        
        <div class="activity-feed" id="activity-feed">
            <div class="activity-loading">Connecting...</div>
        </div>
    </div>

    <!-- Scheduler Status -->
    <div class="section scheduler-section">
        <div class="section-header">
            <h2>‚öôÔ∏è Scheduler</h2>
            <div class="scheduler-controls">
                <span id="scheduler-status" class="status-badge">Loading...</span>
                <button class="btn btn-sm btn-success" id="btn-start-scheduler" onclick="startScheduler()">‚ñ∂ Start</button>
                <button class="btn btn-sm btn-danger" id="btn-stop-scheduler" onclick="stopScheduler()">‚èπ Stop</button>
            </div>
        </div>
        
        <div class="jobs-grid" id="jobs-list">
            <!-- Filled by JS -->
        </div>
    </div>

    <!-- Sleeper Status -->
    <div class="section">
        <div class="section-header">
            <h2>üéØ Sleeper Status</h2>
            <a href="{{ url_for('sleepers_page') }}" class="btn btn-sm">View All ‚Üí</a>
        </div>
        
        <div class="sleeper-counts">
            <div class="count-badge total">
                <span class="count">{{ sleeper_counts.total }}</span>
                <span class="label">Total</span>
            </div>
            <div class="count-badge watching">
                <span class="count">{{ sleeper_counts.watching }}</span>
                <span class="label">Watching</span>
            </div>
            <div class="count-badge building">
                <span class="count">{{ sleeper_counts.building }}</span>
                <span class="label">Building</span>
            </div>
            <div class="count-badge ready">
                <span class="count">{{ sleeper_counts.ready }}</span>
                <span class="label">Ready üî•</span>
            </div>
        </div>

        {% if sleepers %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>State</th>
                    <th>Direction</th>
                    <th>Score</th>
                    <th>HP</th>
                    <th>RSI</th>
                </tr>
            </thead>
            <tbody>
                {% for s in sleepers %}
                <tr>
                    <td class="symbol">{{ s.symbol }}</td>
                    <td>
                        <span class="state-badge {{ s.state|lower }}">{{ s.state }}</span>
                    </td>
                    <td>
                        <span class="direction {{ s.direction|lower if s.direction else '' }}">
                            {{ s.direction or 'N/A' }}
                        </span>
                    </td>
                    <td>{{ "%.1f"|format(s.total_score or 0) }}</td>
                    <td>
                        <span class="hp-badge">{{ s.hp }}/10</span>
                    </td>
                    <td>{{ "%.1f"|format(s.rsi or 0) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">No sleeper candidates yet. Run a scan to find them.</div>
        {% endif %}
    </div>

    <!-- Open Positions -->
    <div class="section">
        <div class="section-header">
            <h2>üìà Open Positions</h2>
            {% if open_trades %}
            <button class="btn btn-danger btn-sm" onclick="closeAllTrades()">Close All</button>
            {% endif %}
        </div>

        {% if open_trades %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Direction</th>
                    <th>Entry</th>
                    <th>Size</th>
                    <th>P&L</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for t in open_trades %}
                <tr>
                    <td class="symbol">{{ t.symbol }}</td>
                    <td>
                        <span class="direction {{ t.direction|lower }}">{{ t.direction }}</span>
                    </td>
                    <td>${{ "%.4f"|format(t.entry_price) }}</td>
                    <td>${{ "%.2f"|format(t.position_size) }}</td>
                    <td class="{% if (t.pnl_usdt or 0) >= 0 %}positive{% else %}negative{% endif %}">
                        ${{ "%.2f"|format(t.pnl_usdt or 0) }}
                    </td>
                    <td>
                        <button class="btn btn-danger btn-xs" onclick="closeTrade({{ t.id }})">Close</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="empty-state">No open positions</div>
        {% endif %}
    </div>

    <!-- Recent Events (from DB) -->
    <div class="section">
        <div class="section-header">
            <h2>üìã Event Log</h2>
            <button class="btn btn-xs" onclick="refreshEvents()">üîÑ</button>
        </div>

        <div class="events-list" id="events-list">
            {% for e in recent_events %}
            <div class="event-item {{ e.level|lower }}">
                <span class="event-time">{{ e.timestamp[11:19] if e.timestamp else '--:--:--' }}</span>
                <span class="event-category">{{ e.category }}</span>
                <span class="event-message">{{ e.message }}</span>
                {% if e.symbol %}
                <span class="event-symbol">{{ e.symbol }}</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
/* Live Activity Styles */
.activity-section {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    border: 1px solid #0f3460;
}

.live-indicator {
    font-size: 0.9rem;
    padding: 4px 12px;
    border-radius: 12px;
    background: rgba(255,255,255,0.1);
}

.live-indicator.online {
    color: #00ff88;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.activity-feed {
    max-height: 200px;
    overflow-y: auto;
    font-family: 'Consolas', 'Monaco', monospace;
    font-size: 0.85rem;
    background: #0a0a15;
    border-radius: 8px;
    padding: 12px;
}

.activity-item {
    padding: 4px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    display: flex;
    gap: 10px;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-time {
    color: #666;
    min-width: 70px;
}

.activity-type {
    font-weight: bold;
    min-width: 80px;
}

.activity-type.sleeper { color: #ffa500; }
.activity-type.ob { color: #00bcd4; }
.activity-type.signal { color: #ff4081; }
.activity-type.trade { color: #4caf50; }
.activity-type.scheduler { color: #9c27b0; }

.activity-msg {
    color: #ccc;
    flex: 1;
}

.activity-loading {
    color: #666;
    text-align: center;
    padding: 20px;
}

/* Job cards improvements */
.job-card {
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.job-name {
    font-weight: bold;
    color: #fff;
}

.job-meta {
    display: flex;
    gap: 15px;
    font-size: 0.8rem;
    color: #888;
}

.job-meta span {
    display: flex;
    align-items: center;
    gap: 4px;
}
</style>

<script>
// === Live Activity Feed ===
let activityItems = [];
let lastEventId = 0;

async function loadActivity() {
    try {
        const res = await fetch('/api/events?limit=20');
        const data = await res.json();
        
        if (data.success && data.data.length > 0) {
            document.getElementById('live-status').textContent = 'üü¢ Online';
            document.getElementById('live-status').classList.add('online');
            
            renderActivity(data.data);
        }
    } catch (err) {
        document.getElementById('live-status').textContent = 'üî¥ Offline';
        document.getElementById('live-status').classList.remove('online');
    }
}

function renderActivity(events) {
    const feed = document.getElementById('activity-feed');
    
    let html = '';
    for (const e of events.slice(0, 15)) {
        const time = e.timestamp ? e.timestamp.substring(11, 19) : '--:--:--';
        const category = (e.category || 'SYSTEM').toLowerCase();
        const symbol = e.symbol ? ` [${e.symbol}]` : '';
        
        html += `
            <div class="activity-item">
                <span class="activity-time">${time}</span>
                <span class="activity-type ${category}">${e.category || 'SYSTEM'}</span>
                <span class="activity-msg">${e.message}${symbol}</span>
            </div>
        `;
    }
    
    feed.innerHTML = html || '<div class="activity-loading">No recent activity</div>';
}

// Load activity every 5 seconds
document.addEventListener('DOMContentLoaded', loadActivity);
setInterval(loadActivity, 5000);

async function refreshEvents() {
    await loadActivity();
}

// === Scheduler functions ===
async function loadSchedulerStatus() {
    try {
        const res = await fetch('/api/scheduler/status');
        const data = await res.json();
        
        if (data.success) {
            const status = data.data;
            const statusEl = document.getElementById('scheduler-status');
            const startBtn = document.getElementById('btn-start-scheduler');
            const stopBtn = document.getElementById('btn-stop-scheduler');
            const jobsList = document.getElementById('jobs-list');
            
            if (status.is_running) {
                statusEl.textContent = 'üü¢ Running';
                statusEl.className = 'status-badge running';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
            } else {
                statusEl.textContent = 'üî¥ Stopped';
                statusEl.className = 'status-badge stopped';
                startBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
            }
            
            // Render jobs
            let html = '';
            for (const job of status.jobs) {
                const stats = status.job_stats[job.id] || {};
                const lastRun = stats.last_run ? new Date(stats.last_run).toLocaleTimeString() : 'Never';
                const nextRun = job.next_run ? new Date(job.next_run).toLocaleTimeString() : 'N/A';
                const successRate = stats.runs > 0 ? Math.round((stats.success / stats.runs) * 100) : 0;
                
                html += `
                    <div class="job-card">
                        <div class="job-name">${job.name}</div>
                        <div class="job-meta">
                            <span>‚è± Last: ${lastRun}</span>
                            <span>‚è≠ Next: ${nextRun}</span>
                            <span>üìä ${stats.runs || 0} runs (${successRate}% ‚úì)</span>
                        </div>
                        <button class="btn btn-xs btn-secondary" onclick="triggerJob('${job.id}')">‚ñ∂ Run Now</button>
                    </div>
                `;
            }
            jobsList.innerHTML = html || '<div class="empty-state">No jobs configured</div>';
        }
    } catch (err) {
        console.error('Failed to load scheduler status:', err);
    }
}

async function startScheduler() {
    try {
        const res = await fetch('/api/scheduler/start', { method: 'POST' });
        const data = await res.json();
        alert(data.message);
        loadSchedulerStatus();
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function stopScheduler() {
    if (!confirm('Stop scheduler? Automatic scans will pause.')) return;
    try {
        const res = await fetch('/api/scheduler/stop', { method: 'POST' });
        const data = await res.json();
        alert(data.message);
        loadSchedulerStatus();
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function triggerJob(jobId) {
    try {
        const res = await fetch(`/api/scheduler/trigger/${jobId}`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            // Show running indicator
            document.getElementById('live-status').textContent = '‚ö° Running...';
        }
        
        // Refresh after a moment
        setTimeout(() => {
            loadSchedulerStatus();
            loadActivity();
        }, 2000);
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

// Load on page load
document.addEventListener('DOMContentLoaded', loadSchedulerStatus);
setInterval(loadSchedulerStatus, 30000); // Refresh every 30s

async function runFullScan() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = '‚è≥ Scanning...';
    document.getElementById('live-status').textContent = '‚ö° Scanning...';
    
    try {
        const res = await fetch('/api/scan/full', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            alert(`Scan complete! ${data.data.length} signals found.`);
            location.reload();
        } else {
            alert('Scan failed: ' + data.error);
        }
    } catch (err) {
        alert('Error: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Full Scan';
    }
}

async function refreshStats() {
    location.reload();
}

async function closeTrade(tradeId) {
    if (!confirm('Close this trade?')) return;
    
    try {
        const res = await fetch(`/api/trade/close/${tradeId}`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert('Failed: ' + data.error);
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function closeAllTrades() {
    if (!confirm('Close ALL open trades?')) return;
    
    try {
        const res = await fetch('/api/trade/close-all', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            alert(`Closed ${data.data.length} trades`);
            location.reload();
        } else {
            alert('Failed: ' + data.error);
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}
</script>
{% endblock %}
