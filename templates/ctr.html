{% extends "base.html" %}
{% block title %}CTR Scanner{% endblock %}

{% block content %}
<style>
    .ctr-container {
        max-width: 1400px;
        margin: 0 auto;
    }
    
    .ctr-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
    }
    
    .ctr-title h1 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .status-badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
    }
    
    .status-running {
        background: rgba(0, 200, 83, 0.2);
        color: #00c853;
        animation: pulse 2s infinite;
    }
    
    .status-stopped {
        background: rgba(255, 82, 82, 0.2);
        color: #ff5252;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    .ctr-controls {
        display: flex;
        gap: 10px;
    }
    
    .ctr-grid {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 20px;
    }
    
    @media (max-width: 900px) {
        .ctr-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .ctr-panel {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
    }
    
    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .panel-header h2 {
        margin: 0;
        font-size: 1.1em;
    }
    
    /* Watchlist */
    .watchlist-input {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .watchlist-input input {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.3);
        color: white;
        text-transform: uppercase;
    }
    
    .watchlist-items {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .watchlist-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        margin-bottom: 8px;
    }
    
    .watchlist-item:hover {
        background: rgba(0, 0, 0, 0.4);
    }
    
    .watchlist-symbol {
        font-weight: bold;
        font-family: monospace;
    }
    
    .watchlist-remove {
        background: rgba(255, 82, 82, 0.2);
        border: none;
        color: #ff5252;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }
    
    .watchlist-remove:hover {
        background: rgba(255, 82, 82, 0.4);
    }
    
    /* Results Table */
    .results-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .results-table th,
    .results-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .results-table th {
        background: rgba(0, 0, 0, 0.3);
        font-weight: 600;
        font-size: 0.85em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .results-table tbody tr:hover {
        background: rgba(255, 255, 255, 0.05);
    }
    
    .stc-value {
        font-family: monospace;
        font-weight: bold;
    }
    
    .stc-oversold {
        color: #00c853;
    }
    
    .stc-overbought {
        color: #ff5252;
    }
    
    .stc-neutral {
        color: #888;
    }
    
    .signal-badge {
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: bold;
    }
    
    .signal-buy {
        background: rgba(0, 200, 83, 0.2);
        color: #00c853;
    }
    
    .signal-sell {
        background: rgba(255, 82, 82, 0.2);
        color: #ff5252;
    }
    
    /* Settings Panel */
    
    /* Trade Toggle in Watchlist */
    .trade-toggle {
        display: flex; align-items: center; gap: 3px;
        cursor: pointer; font-size: 0.75em; padding: 2px 6px;
        border-radius: 4px; transition: all 0.2s;
        user-select: none;
    }
    .trade-toggle.active {
        background: rgba(0,200,83,0.2); color: #00c853;
    }
    .trade-toggle.inactive {
        background: rgba(255,255,255,0.05); color: #666;
    }
    .trade-toggle:hover { opacity: 0.8; }
    
    /* Trade Settings Panel */
    .trade-panel { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
    .trade-toggle-main {
        display: flex; align-items: center; justify-content: space-between;
        padding: 8px 12px; border-radius: 8px; margin-bottom: 12px;
        transition: all 0.2s;
    }
    .trade-toggle-main.enabled { background: rgba(0,200,83,0.15); border: 1px solid rgba(0,200,83,0.3); }
    .trade-toggle-main.disabled { background: rgba(255,82,82,0.1); border: 1px solid rgba(255,82,82,0.2); }
    
    /* Switch toggle */
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
              background-color: #555; transition: .3s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
                     background-color: white; transition: .3s; border-radius: 50%; }
    input:checked + .slider { background-color: #00c853; }
    input:checked + .slider:before { transform: translateX(20px); }
    
    /* Position card */
    .position-card {
        display: flex; justify-content: space-between; align-items: center;
        padding: 8px 10px; margin-bottom: 6px; border-radius: 6px;
        font-size: 0.85em;
    }
    .position-card.long { background: rgba(0,200,83,0.1); border-left: 3px solid #00c853; }
    .position-card.short { background: rgba(255,82,82,0.1); border-left: 3px solid #ff5252; }
    .settings-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    .setting-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .setting-item label {
        font-size: 0.85em;
        color: #888;
    }
    
    .setting-item input,
    .setting-item select {
        padding: 8px 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        background: rgba(0, 0, 0, 0.3);
        color: white;
    }
    
    /* Stats */
    .stats-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.8em;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 0.85em;
        color: #888;
    }
    
    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #888;
    }
    
    .empty-state i {
        font-size: 3em;
        margin-bottom: 15px;
        opacity: 0.5;
    }
</style>

<div class="ctr-container">
    <div class="ctr-header">
        <div class="ctr-title">
            <h1>üìä CTR Scanner <small style="font-size:0.5em; color:#888;">v2.0 Fast</small></h1>
            <span class="status-badge {{ 'status-running' if ctr_running else 'status-stopped' }}" id="ctr-status">
                {{ '‚óè RUNNING' if ctr_running else '‚óã STOPPED' }}
            </span>
            {% if ctr_running %}
            <span class="status-badge {{ 'status-running' if ws_connected else 'status-stopped' }}" id="ws-status" style="margin-left: 5px;">
                {{ 'üîó WS' if ws_connected else '‚ö†Ô∏è WS' }}
            </span>
            {% endif %}
        </div>
        <div class="ctr-controls">
            <label class="checkbox-label" style="display: flex; align-items: center; gap: 5px; margin-right: 15px; background: rgba(255,200,0,0.1); padding: 5px 12px; border-radius: 6px;">
                <input type="checkbox" id="ctr-only-mode" {{ 'checked' if ctr_only_mode else '' }} onchange="toggleCTROnlyMode(this)">
                <span style="font-size: 0.9em;">CTR Only Mode</span>
            </label>
            <button class="btn btn-success" onclick="startCTR()" id="btn-start" {{ 'disabled' if ctr_running else '' }}>
                ‚ñ∂Ô∏è Start
            </button>
            <button class="btn btn-danger" onclick="stopCTR()" id="btn-stop" {{ 'disabled' if not ctr_running else '' }}>
                ‚èπÔ∏è Stop
            </button>
            <button class="btn btn-primary" onclick="scanNow()">
                üîÑ Scan Now
            </button>
        </div>
    </div>
    
    <!-- Stats Row -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-value" id="stat-watchlist">{{ watchlist|length }}</div>
            <div class="stat-label">Symbols</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stc-oversold" id="stat-oversold">{{ oversold_count }}</div>
            <div class="stat-label">Oversold</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stc-overbought" id="stat-overbought">{{ overbought_count }}</div>
            <div class="stat-label">Overbought</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="stat-signals">{{ signals_today }}</div>
            <div class="stat-label">Signals Today</div>
        </div>
    </div>
    
    <div class="ctr-grid">
        <!-- Left Panel: Watchlist + Settings -->
        <div>
            <!-- Watchlist -->
            <div class="ctr-panel" style="margin-bottom: 20px;">
                <div class="panel-header">
                    <h2>üìã Watchlist</h2>
                    <span id="watchlist-count">{{ watchlist|length }} symbols</span>
                </div>
                
                <div class="watchlist-input">
                    <input type="text" id="new-symbol" placeholder="BTCUSDT" 
                           onkeypress="if(event.key==='Enter')addSymbol()">
                    <button class="btn btn-primary" onclick="addSymbol()">+ Add</button>
                </div>
                
                <div class="watchlist-items" id="watchlist-items">
                    {% if watchlist %}
                        {% for symbol in watchlist %}
                        <div class="watchlist-item" data-symbol="{{ symbol }}">
                            <span class="watchlist-symbol">{{ symbol }}</span>
                            <div style="display:flex;align-items:center;gap:6px;">
                                <span class="trade-toggle {{ 'active' if symbol in trade_settings.trade_symbols else 'inactive' }}"
                                      onclick="toggleTradeSymbol('{{ symbol }}', this)"
                                      title="–£–≤—ñ–º–∫–Ω—É—Ç–∏ —Ç–æ—Ä–≥—ñ–≤–ª—é –ø–æ {{ symbol }}">
                                    üí∞ {{ 'Trade' if symbol in trade_settings.trade_symbols else 'Off' }}
                                </span>
                                <button class="watchlist-remove" onclick="removeSymbol('{{ symbol }}')">‚úï</button>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <p>No symbols in watchlist</p>
                            <small>Add symbols above to start monitoring</small>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Settings -->
            <div class="ctr-panel">
                <div class="panel-header">
                    <h2>‚öôÔ∏è Settings</h2>
                    <button class="btn btn-sm btn-secondary" onclick="saveSettings()">Save</button>
                </div>
                
                <div class="settings-grid">
                    <div class="setting-item">
                        <label>Timeframe</label>
                        <select id="ctr_timeframe">
                            <option value="1m" {{ 'selected' if settings.ctr_timeframe == '1m' else '' }}>1m</option>
                            <option value="5m" {{ 'selected' if settings.ctr_timeframe == '5m' else '' }}>5m</option>
                            <option value="15m" {{ 'selected' if settings.ctr_timeframe == '15m' or not settings.ctr_timeframe else '' }}>15m</option>
                            <option value="1h" {{ 'selected' if settings.ctr_timeframe == '1h' else '' }}>1h</option>
                            <option value="4h" {{ 'selected' if settings.ctr_timeframe == '4h' else '' }}>4h</option>
                        </select>
                    </div>
                    
                    <div class="setting-item">
                        <label>Fast EMA</label>
                        <input type="number" id="ctr_fast_length" value="{{ settings.ctr_fast_length or 21 }}" min="5" max="50">
                    </div>
                    
                    <div class="setting-item">
                        <label>Slow EMA</label>
                        <input type="number" id="ctr_slow_length" value="{{ settings.ctr_slow_length or 50 }}" min="20" max="100">
                    </div>
                    
                    <div class="setting-item">
                        <label>Cycle Length</label>
                        <input type="number" id="ctr_cycle_length" value="{{ settings.ctr_cycle_length or 10 }}" min="5" max="30">
                    </div>
                    
                    <div class="setting-item">
                        <label>Upper Level</label>
                        <input type="number" id="ctr_upper" value="{{ settings.ctr_upper or 75 }}" min="60" max="95">
                    </div>
                    
                    <div class="setting-item">
                        <label>Lower Level</label>
                        <input type="number" id="ctr_lower" value="{{ settings.ctr_lower or 25 }}" min="5" max="40">
                    </div>
                </div>
                
                <!-- Signal Filters Section (v2.6) -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="margin-bottom: 10px;">üîß –§—ñ–ª—å—Ç—Ä–∏ —Å–∏–≥–Ω–∞–ª—ñ–≤</h4>
                    <small style="color: #888; display: block; margin-bottom: 10px;">
                        –í—Å—ñ OFF = 100% –æ—Ä–∏–≥—ñ–Ω–∞–ª Pine Script (—Ç—ñ–ª—å–∫–∏ crossover/crossunder)
                    </small>
                    
                    <div class="setting-item">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="ctr_use_trend_guard" {{ 'checked' if settings.ctr_use_trend_guard else '' }} onchange="saveSettings()">
                            üõ°Ô∏è Trend Guard
                        </label>
                        <small style="color:#666;margin-left:26px;">–ê–≤–∞—Ä—ñ–π–Ω–∏–π –≤–∏—Ö—ñ–¥ –∫–æ–ª–∏ STC –Ω–µ –¥–æ—Å—è–≥–∞—î —Ü—ñ–ª—ñ</small>
                    </div>
                    
                    <div class="setting-item">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="ctr_use_gap_detection" {{ 'checked' if settings.ctr_use_gap_detection else '' }} onchange="saveSettings()">
                            ‚ö° Gap Detection
                        </label>
                        <small style="color:#666;margin-left:26px;">–ü—Ä–æ–ø—É—â–µ–Ω—ñ crossover –º—ñ–∂ —Å–∫–∞–Ω–∞–º–∏ (Hidden Peak)</small>
                    </div>
                    
                    <div class="setting-item">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="ctr_use_cooldown" {{ 'checked' if settings.ctr_use_cooldown else '' }} onchange="toggleCooldownVisibility()">
                            ‚è±Ô∏è Cooldown
                        </label>
                        <small style="color:#666;margin-left:26px;">–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –º—ñ–∂ —Å–∏–≥–Ω–∞–ª–∞–º–∏</small>
                    </div>
                    
                    <div class="setting-item" id="cooldown_seconds_row" style="display: {{ 'block' if settings.ctr_use_cooldown else 'none' }};">
                        <label>Cooldown (—Å–µ–∫)</label>
                        <input type="number" id="ctr_cooldown_seconds" value="{{ settings.ctr_cooldown_seconds or 300 }}" min="10" max="3600" step="10">
                    </div>
                </div>
                
                <!-- SMC Filter Section -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        üìä SMC Structure Filter
                        <span class="status-badge {{ 'status-running' if smc_filter_enabled else 'status-stopped' }}" style="font-size: 0.7em;">
                            {{ 'ON' if smc_filter_enabled else 'OFF' }}
                        </span>
                    </h4>
                    
                    <div class="setting-item">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="ctr_smc_filter_enabled" {{ 'checked' if settings.ctr_smc_filter_enabled else '' }} onchange="saveSettings()">
                            Enable SMC Filter
                        </label>
                    </div>
                    
                    <div class="setting-item">
                        <label>Swing Length</label>
                        <input type="number" id="ctr_smc_swing_length" value="{{ settings.ctr_smc_swing_length or 50 }}" min="10" max="100">
                    </div>
                    
                    <div class="setting-item">
                        <label>Zone Threshold (%)</label>
                        <input type="number" id="ctr_smc_zone_threshold" value="{{ settings.ctr_smc_zone_threshold or 1.0 }}" min="0.5" max="5" step="0.1">
                    </div>
                    
                    <div class="setting-item">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="ctr_smc_require_trend" {{ 'checked' if settings.ctr_smc_require_trend else '' }} onchange="saveSettings()">
                            Require Trend for Zones
                        </label>
                        <small style="color:#666;margin-left:26px;">Premium ‚Üí SELL only if bearish, Discount ‚Üí BUY only if bullish</small>
                    </div>
                    
                    <small style="color: #888; display: block; margin-top: 10px;">
                        <b>SMC Filter:</b> Validates signals at key structure levels<br>
                        ‚Ä¢ BUY: Near Strong Low or HL (Higher Low)<br>
                        ‚Ä¢ SELL: Near Weak High or LH (Lower High)<br>
                        {% if signals_filtered %}<span style="color: #ff9800;">Filtered: {{ signals_filtered }} signals</span>{% endif %}
                    </small>
                </div>
                
                <!-- SMC Trend Filter (HTF 4h/1h) -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        üî≠ SMC Trend Filter (HTF)
                        <span class="status-badge {{ 'status-running' if settings.ctr_smc_trend_enabled else 'status-stopped' }}" style="font-size: 0.7em;">
                            {{ 'ON' if settings.ctr_smc_trend_enabled else 'OFF' }}
                        </span>
                    </h4>
                    
                    <div class="setting-item">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="ctr_smc_trend_enabled" {{ 'checked' if settings.ctr_smc_trend_enabled else '' }} onchange="saveSettings()">
                            –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –ø–æ HTF —Ç—Ä–µ–Ω–¥—É
                        </label>
                        <small style="color:#666;margin-left:26px;">BUY —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ BULLISH, SELL —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ BEARISH</small>
                    </div>
                    
                    <div class="setting-item">
                        <label>–†–µ–∂–∏–º</label>
                        <select id="ctr_smc_trend_mode" onchange="saveSettings()">
                            <option value="both" {{ 'selected' if settings.ctr_smc_trend_mode == 'both' else '' }}>Both (–æ–±–∏–¥–≤–∞ TF)</option>
                            <option value="any" {{ 'selected' if settings.ctr_smc_trend_mode == 'any' else '' }}>Any (—Ö–æ—á–∞ –± –æ–¥–∏–Ω)</option>
                            <option value="4h" {{ 'selected' if settings.ctr_smc_trend_mode == '4h' else '' }}>4H Only</option>
                            <option value="1h" {{ 'selected' if settings.ctr_smc_trend_mode == '1h' else '' }}>1H Only</option>
                        </select>
                    </div>
                    
                    <div class="setting-item">
                        <label>4H Swing Length</label>
                        <input type="number" id="ctr_smc_trend_swing_4h" value="{{ settings.ctr_smc_trend_swing_4h or 50 }}" min="10" max="200">
                    </div>
                    
                    <div class="setting-item">
                        <label>1H Swing Length</label>
                        <input type="number" id="ctr_smc_trend_swing_1h" value="{{ settings.ctr_smc_trend_swing_1h or 50 }}" min="10" max="200">
                    </div>
                    
                    <div class="setting-item">
                        <label>–û–Ω–æ–≤–ª–µ–Ω–Ω—è (—Å–µ–∫)</label>
                        <input type="number" id="ctr_smc_trend_refresh" value="{{ settings.ctr_smc_trend_refresh or 900 }}" min="60" max="7200" step="60">
                    </div>
                    
                    <div class="setting-item">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="ctr_smc_trend_block_neutral" {{ 'checked' if settings.ctr_smc_trend_block_neutral else '' }} onchange="saveSettings()">
                            üö´ –ë–ª–æ–∫—É–≤–∞—Ç–∏ –ø—Ä–∏ NEUTRAL
                        </label>
                        <small style="color:#666;margin-left:26px;">–°–∏–≥–Ω–∞–ª–∏ —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ —á—ñ—Ç–∫–æ–º—É BULLISH/BEARISH —Ç—Ä–µ–Ω–¥—ñ</small>
                    </div>
                    
                    <small style="color: #888; display: block; margin-top: 10px;">
                        <b>–†–µ–∂–∏–º–∏:</b><br>
                        ‚Ä¢ Both ‚Äî –∂–æ–¥–µ–Ω TF –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø—Ä–æ—Ç–∏–ª–µ–∂–Ω–∏–º<br>
                        ‚Ä¢ Any ‚Äî –±–ª–æ–∫—É—î —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –æ–±–∏–¥–≤–∞ –ø—Ä–æ—Ç–∏–ª–µ–∂–Ω—ñ<br>
                        ‚Ä¢ 4H/1H Only ‚Äî —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω TF<br>
                        ‚Ä¢ üö´ Block NEUTRAL ‚Äî –±–ª–æ–∫—É—î –í–°–ï —è–∫—â–æ —Ç—Ä–µ–Ω–¥ –Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π
                    </small>
                </div>
                
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <small style="color: #888;">
                        <b>CTR Algorithm:</b> Schaff Trend Cycle<br>
                        BUY: STC crosses above {{ settings.ctr_lower or 25 }}<br>
                        SELL: STC crosses below {{ settings.ctr_upper or 75 }}
                    </small>
                </div>
                
                <!-- Trade Settings -->
                <div class="trade-panel">
                    <h4 style="margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                        üí∞ Auto-Trade (Bybit Futures)
                        <span class="status-badge {{ 'status-running' if trade_settings.enabled else 'status-stopped' }}" style="font-size: 0.7em;">
                            {{ 'ON' if trade_settings.enabled else 'OFF' }}
                        </span>
                    </h4>
                    
                    <div class="trade-toggle-main {{ 'enabled' if trade_settings.enabled else 'disabled' }}" id="trade-toggle-bar">
                        <span style="font-size:0.9em;">
                            {{ 'üü¢ –ê–≤—Ç–æ—Ç–æ—Ä–≥—ñ–≤–ª—è —É–≤—ñ–º–∫–Ω–µ–Ω–∞' if trade_settings.enabled else 'üî¥ –ê–≤—Ç–æ—Ç–æ—Ä–≥—ñ–≤–ª—è –≤–∏–º–∫–Ω–µ–Ω–∞' }}
                        </span>
                        <label class="switch">
                            <input type="checkbox" id="trade-enabled" {{ 'checked' if trade_settings.enabled else '' }}
                                   onchange="toggleAutoTrade(this)">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="settings-grid">
                        <div class="setting-item">
                            <label>Leverage</label>
                            <input type="number" id="trade_leverage" value="{{ trade_settings.leverage }}" min="1" max="100">
                        </div>
                        <div class="setting-item">
                            <label>Deposit %</label>
                            <input type="number" id="trade_deposit_pct" value="{{ trade_settings.deposit_pct }}" min="0.1" max="50" step="0.5">
                        </div>
                        <div class="setting-item">
                            <label>TP %</label>
                            <input type="number" id="trade_tp_pct" value="{{ trade_settings.tp_pct }}" min="0" max="100" step="0.5">
                        </div>
                        <div class="setting-item">
                            <label>SL %</label>
                            <input type="number" id="trade_sl_pct" value="{{ trade_settings.sl_pct }}" min="0" max="50" step="0.5">
                        </div>
                        <div class="setting-item">
                            <label>Max Positions</label>
                            <input type="number" id="trade_max_positions" value="{{ trade_settings.max_positions }}" min="1" max="20">
                        </div>
                    </div>
                    
                    <button class="btn btn-sm btn-secondary" onclick="saveTradeSettings()" style="margin-top:10px;width:100%;">
                        üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ Trade Settings
                    </button>
                    
                    <!-- Active Positions -->
                    <div id="trade-positions" style="margin-top:12px;">
                        <small style="color:#888;">–ü–æ–∑–∏—Ü—ñ—ó –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è...</small>
                    </div>
                    
                    <small style="color: #888; display: block; margin-top: 10px;">
                        <b>Isolated margin</b> ‚Ä¢ Market orders<br>
                        –í—ñ–¥–º—ñ—Ç—å—Ç–µ üí∞ –±—ñ–ª—è —Å–∏–º–≤–æ–ª—É –≤ Watchlist –¥–ª—è —Ç–æ—Ä–≥—ñ–≤–ª—ñ<br>
                        <span style="color:#ff9800;">‚ö†Ô∏è –†–µ–∞–ª—å–Ω—ñ –≥—Ä–æ—à—ñ! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.</span>
                    </small>
                </div>
            </div>
        </div>
        
        <!-- Right Panel: Scan Results -->
        <div class="ctr-panel">
            <div class="panel-header">
                <h2>üìà Scan Results</h2>
                <span id="last-scan-time">{{ last_scan_time or 'Never' }}</span>
            </div>
            
            {% if scan_results %}
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Price</th>
                        <th>STC</th>
                        <th>Status</th>
                        <th>SMC Trend</th>
                        <th>Signal</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                    {% for r in scan_results %}
                    <tr>
                        <td><b>{{ r.symbol }}</b></td>
                        <td>${{ "%.8f"|format(r.price) if r.price < 1 else "%.4f"|format(r.price) if r.price < 100 else "%.2f"|format(r.price) }}</td>
                        <td class="stc-value {{ 'stc-oversold' if r.stc <= 25 else 'stc-overbought' if r.stc >= 75 else 'stc-neutral' }}">
                            {{ "%.2f"|format(r.stc) }}
                        </td>
                        <td>
                            {% if r.status == 'Oversold' %}
                                <span style="color: #00c853;">üü¢ Oversold</span>
                            {% elif r.status == 'Overbought' %}
                                <span style="color: #ff5252;">üî¥ Overbought</span>
                            {% else %}
                                <span style="color: #888;">‚ö™ Neutral</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if r.smc_trend and r.smc_trend is mapping %}
                                {% set t4h = r.smc_trend.get('4h', 'N/A') %}
                                {% set t1h = r.smc_trend.get('1h', 'N/A') %}
                                <span title="4h: {{ t4h }} | 1h: {{ t1h }}">
                                    <small style="color: {{ '#00c853' if t4h == 'BULLISH' else '#ff5252' if t4h == 'BEARISH' else '#888' }};">4h:{{ 'üü¢' if t4h == 'BULLISH' else 'üî¥' if t4h == 'BEARISH' else '‚ö™' }}</small>
                                    <small style="color: {{ '#00c853' if t1h == 'BULLISH' else '#ff5252' if t1h == 'BEARISH' else '#888' }};">1h:{{ 'üü¢' if t1h == 'BULLISH' else 'üî¥' if t1h == 'BEARISH' else '‚ö™' }}</small>
                                </span>
                            {% elif r.smc_trend and r.smc_trend is string %}
                                {% if r.smc_trend == 'BULLISH' %}
                                    <span style="color: #00c853; font-weight: bold;">üü¢ BULL</span>
                                {% elif r.smc_trend == 'BEARISH' %}
                                    <span style="color: #ff5252; font-weight: bold;">üî¥ BEAR</span>
                                {% else %}
                                    <span style="color: #888;">‚ö™ {{ r.smc_trend }}</span>
                                {% endif %}
                            {% else %}
                                <span style="color: #444;">‚Äî</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if r.buy_signal %}
                                <span class="signal-badge signal-buy">üü¢ BUY</span>
                            {% elif r.sell_signal %}
                                <span class="signal-badge signal-sell">üî¥ SELL</span>
                            {% else %}
                                <span style="color: #666;">‚Äî</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <div style="font-size: 3em; opacity: 0.5;">üìä</div>
                <p>No scan results yet</p>
                <small>Add symbols to watchlist and click "Scan Now"</small>
            </div>
            {% endif %}
            
            <!-- Executed Signals History -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <div class="panel-header">
                    <h2>üéØ Executed Signals</h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>{{ ctr_signals|length }} signals</span>
                        {% if ctr_signals %}
                        <button class="btn btn-sm" style="background: rgba(255,82,82,0.2); color: #ff5252; border: 1px solid rgba(255,82,82,0.3); padding: 4px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8em;" onclick="clearAllSignals()">
                            üóëÔ∏è Clear All
                        </button>
                        {% endif %}
                    </div>
                </div>
                
                {% if ctr_signals %}
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Symbol</th>
                            <th>Signal</th>
                            <th>Price</th>
                            <th>STC</th>
                            <th>Reason</th>
                            <th style="width: 40px;"></th>
                        </tr>
                    </thead>
                    <tbody id="signals-body">
                        {% for sig in ctr_signals %}
                        <tr id="signal-row-{{ loop.index0 }}">
                            <td style="font-family: monospace; font-size: 0.85em;">
                                {{ sig.timestamp[:19].replace('T', ' ') if sig.timestamp else '‚Äî' }}
                            </td>
                            <td><b>{{ sig.symbol }}</b></td>
                            <td>
                                {% if sig.type == 'BUY' %}
                                    <span class="signal-badge signal-buy">üü¢ LONG</span>
                                {% else %}
                                    <span class="signal-badge signal-sell">üî¥ SHORT</span>
                                {% endif %}
                            </td>
                            <td>${{ "%.8f"|format(sig.price) if sig.price < 1 else "%.4f"|format(sig.price) if sig.price < 100 else "%.2f"|format(sig.price) }}</td>
                            <td class="stc-value {{ 'stc-oversold' if sig.stc <= 25 else 'stc-overbought' if sig.stc >= 75 else 'stc-neutral' }}">
                                {{ "%.2f"|format(sig.stc) }}
                            </td>
                            <td style="font-size: 0.8em; color: {{ '#ff9800' if 'Trend Guard' in (sig.reason|default('')) else '#4fc3f7' if 'Gap' in (sig.reason|default('')) else '#aaa' }};">
                                {{ sig.reason|default('Crossover') }}
                            </td>
                            <td>
                                <button class="watchlist-remove" onclick="deleteSignal('{{ sig.timestamp }}', {{ loop.index0 }})" title="–í–∏–¥–∞–ª–∏—Ç–∏">‚úï</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state" style="padding: 20px;">
                    <p style="margin: 0; color: #666;">No signals yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
async function toggleCTROnlyMode(checkbox) {
    const enabled = checkbox.checked;
    
    try {
        const res = await fetch('/api/ctr/only-mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled })
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast(enabled ? 'üîí CTR Only Mode enabled - other scans disabled' : 'üîì CTR Only Mode disabled');
        } else {
            checkbox.checked = !enabled;
            alert(data.error || 'Failed to toggle mode');
        }
    } catch (e) {
        checkbox.checked = !enabled;
        alert('Error: ' + e.message);
    }
}

async function addSymbol() {
    const input = document.getElementById('new-symbol');
    const symbol = input.value.trim().toUpperCase();
    
    if (!symbol) return;
    if (!symbol.endsWith('USDT')) {
        alert('Symbol must end with USDT');
        return;
    }
    
    try {
        const res = await fetch('/api/ctr/watchlist/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol })
        });
        
        const data = await res.json();
        
        if (data.success) {
            input.value = '';
            location.reload();
        } else {
            alert(data.error || 'Failed to add symbol');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function removeSymbol(symbol) {
    if (!confirm(`Remove ${symbol} from watchlist?`)) return;
    
    try {
        const res = await fetch('/api/ctr/watchlist/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol })
        });
        
        const data = await res.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to remove symbol');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function saveSettings() {
    const settings = {
        ctr_timeframe: document.getElementById('ctr_timeframe').value,
        ctr_fast_length: parseInt(document.getElementById('ctr_fast_length').value),
        ctr_slow_length: parseInt(document.getElementById('ctr_slow_length').value),
        ctr_cycle_length: parseInt(document.getElementById('ctr_cycle_length').value),
        ctr_upper: parseInt(document.getElementById('ctr_upper').value),
        ctr_lower: parseInt(document.getElementById('ctr_lower').value),
        // Signal Filters
        ctr_use_trend_guard: document.getElementById('ctr_use_trend_guard').checked ? '1' : '0',
        ctr_use_gap_detection: document.getElementById('ctr_use_gap_detection').checked ? '1' : '0',
        ctr_use_cooldown: document.getElementById('ctr_use_cooldown').checked ? '1' : '0',
        ctr_cooldown_seconds: parseInt(document.getElementById('ctr_cooldown_seconds').value),
        // SMC Filter
        ctr_smc_filter_enabled: document.getElementById('ctr_smc_filter_enabled').checked ? '1' : '0',
        ctr_smc_swing_length: parseInt(document.getElementById('ctr_smc_swing_length').value),
        ctr_smc_zone_threshold: parseFloat(document.getElementById('ctr_smc_zone_threshold').value),
        ctr_smc_require_trend: document.getElementById('ctr_smc_require_trend').checked ? '1' : '0',
        // SMC Trend Filter (HTF)
        ctr_smc_trend_enabled: document.getElementById('ctr_smc_trend_enabled').checked ? '1' : '0',
        ctr_smc_trend_swing_4h: parseInt(document.getElementById('ctr_smc_trend_swing_4h').value),
        ctr_smc_trend_swing_1h: parseInt(document.getElementById('ctr_smc_trend_swing_1h').value),
        ctr_smc_trend_mode: document.getElementById('ctr_smc_trend_mode').value,
        ctr_smc_trend_refresh: parseInt(document.getElementById('ctr_smc_trend_refresh').value),
        ctr_smc_trend_block_neutral: document.getElementById('ctr_smc_trend_block_neutral').checked ? '1' : '0',
    };
    
    try {
        const res = await fetch('/api/ctr/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast('‚úÖ Settings saved!');
        } else {
            alert(data.error || 'Failed to save settings');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

function toggleCooldownVisibility() {
    const checked = document.getElementById('ctr_use_cooldown').checked;
    document.getElementById('cooldown_seconds_row').style.display = checked ? 'block' : 'none';
    saveSettings();
}

async function startCTR() {
    try {
        const res = await fetch('/api/ctr/start', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to start');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function stopCTR() {
    try {
        const res = await fetch('/api/ctr/stop', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to stop');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function scanNow() {
    showToast('üîÑ Scanning...');
    
    try {
        const res = await fetch('/api/ctr/scan', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Scan failed');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

function showToast(message) {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px 25px; border-radius: 8px; z-index: 9999;';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Auto-refresh every 30 seconds if running
{% if ctr_running %}
setInterval(() => {
    location.reload();
}, 30000);
{% endif %}

async function deleteSignal(timestamp, rowIndex) {
    try {
        const res = await fetch('/api/ctr/signals/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ timestamp })
        });
        
        const data = await res.json();
        
        if (data.success) {
            const row = document.getElementById(`signal-row-${rowIndex}`);
            if (row) {
                row.style.transition = 'opacity 0.3s';
                row.style.opacity = '0';
                setTimeout(() => row.remove(), 300);
            }
            showToast('üóëÔ∏è Signal deleted');
        } else {
            alert(data.error || 'Failed to delete signal');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function clearAllSignals() {
    if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –í–°–Ü —Å–∏–≥–Ω–∞–ª–∏? –¶–µ —Ç–∞–∫–æ–∂ —Å–∫–∏–Ω–µ –∫–µ—à –Ω–∞–ø—Ä—è–º–∫—ñ–≤ (–¥–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—é).')) return;
    
    try {
        const res = await fetch('/api/ctr/signals/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast(`üóëÔ∏è Cleared ${data.cleared} signals`);
            setTimeout(() => location.reload(), 500);
        } else {
            alert(data.error || 'Failed to clear signals');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// ================================
// AUTO-TRADE FUNCTIONS
// ================================

async function toggleAutoTrade(checkbox) {
    const enabled = checkbox.checked;
    
    if (enabled && !confirm('‚ö†Ô∏è –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∞–≤—Ç–æ—Ç–æ—Ä–≥—ñ–≤–ª—é?\n–¶–µ –†–ï–ê–õ–¨–ù–Ü –≥—Ä–æ—à—ñ –Ω–∞ Bybit Futures!')) {
        checkbox.checked = false;
        return;
    }
    
    try {
        const res = await fetch('/api/ctr/trade/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled })
        });
        const data = await res.json();
        
        if (data.success) {
            showToast(enabled ? 'üü¢ Auto-Trade ENABLED' : 'üî¥ Auto-Trade DISABLED');
            setTimeout(() => location.reload(), 500);
        } else {
            checkbox.checked = !enabled;
            alert(data.error || 'Failed');
        }
    } catch (e) {
        checkbox.checked = !enabled;
        alert('Error: ' + e.message);
    }
}

async function toggleTradeSymbol(symbol, el) {
    const isActive = el.classList.contains('active');
    const newState = !isActive;
    
    try {
        const res = await fetch('/api/ctr/trade/symbol', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol, enabled: newState })
        });
        const data = await res.json();
        
        if (data.success) {
            el.classList.toggle('active', newState);
            el.classList.toggle('inactive', !newState);
            el.innerHTML = 'üí∞ ' + (newState ? 'Trade' : 'Off');
            showToast(`${symbol}: —Ç–æ—Ä–≥—ñ–≤–ª—è ${newState ? 'ON ‚úÖ' : 'OFF ‚ùå'}`);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function saveTradeSettings() {
    const settings = {
        leverage: parseInt(document.getElementById('trade_leverage').value),
        deposit_pct: parseFloat(document.getElementById('trade_deposit_pct').value),
        tp_pct: parseFloat(document.getElementById('trade_tp_pct').value),
        sl_pct: parseFloat(document.getElementById('trade_sl_pct').value),
        max_positions: parseInt(document.getElementById('trade_max_positions').value),
    };
    
    try {
        const res = await fetch('/api/ctr/trade/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        const data = await res.json();
        
        if (data.success) {
            showToast('‚úÖ Trade settings saved!');
        } else {
            alert('Failed to save trade settings');
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function loadTradePositions() {
    try {
        const res = await fetch('/api/ctr/trade/status');
        const data = await res.json();
        const container = document.getElementById('trade-positions');
        
        if (!data.available) {
            container.innerHTML = '<small style="color:#888;">Bybit –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏–π</small>';
            return;
        }
        
        // Auth error
        if (data.auth_ok === false) {
            container.innerHTML = `<div style="padding:8px;background:rgba(255,82,82,0.1);border-radius:6px;border-left:3px solid #ff5252;">
                <small style="color:#ff5252;">‚ö†Ô∏è Bybit API: ${data.error || 'Auth failed'}</small><br>
                <small style="color:#888;">–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ API –∫–ª—é—á—ñ —Ç–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å</small>
            </div>`;
            return;
        }
        
        let html = '';
        
        if (data.balance > 0) {
            html += `<div style="font-size:0.85em;margin-bottom:8px;color:#ccc;">
                Balance: <b>$${data.balance.toFixed(2)}</b> USDT
                | Positions: ${data.positions_count}/${data.max_positions}
            </div>`;
        }
        
        if (data.positions && data.positions.length > 0) {
            data.positions.forEach(p => {
                const isLong = p.side === 'Buy';
                const pnlColor = p.unrealized_pnl >= 0 ? '#00c853' : '#ff5252';
                html += `<div class="position-card ${isLong ? 'long' : 'short'}">
                    <div>
                        <b>${p.symbol}</b>
                        <span style="color:${isLong ? '#00c853' : '#ff5252'}">${isLong ? 'LONG' : 'SHORT'}</span>
                    </div>
                    <div style="text-align:right;">
                        <span style="color:${pnlColor}">${p.unrealized_pnl >= 0 ? '+' : ''}$${p.unrealized_pnl.toFixed(4)}</span>
                        <br><small style="color:#888;">${p.leverage}x | $${p.position_value.toFixed(2)}</small>
                    </div>
                </div>`;
            });
        } else if (data.enabled) {
            html += '<small style="color:#888;">–ù–µ–º–∞—î –≤—ñ–¥–∫—Ä–∏—Ç–∏—Ö –ø–æ–∑–∏—Ü—ñ–π</small>';
        }
        
        container.innerHTML = html || '<small style="color:#888;">‚Äî</small>';
    } catch (e) {
        document.getElementById('trade-positions').innerHTML =
            '<small style="color:#ff5252;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</small>';
    }
}

// Load positions on page load and refresh periodically
loadTradePositions();
{% if ctr_running %}
setInterval(loadTradePositions, 30000);
{% endif %}
</script>
{% endblock %}
