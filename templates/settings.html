{% extends "base.html" %}
{% block title %}Settings - Sleeper OB Bot{% endblock %}

{% block content %}
<div class="page settings-page">
    <div class="page-header">
        <h1>‚öôÔ∏è Bot Settings</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="resetDefaults()">üîÑ Reset Defaults</button>
        </div>
    </div>

    <form id="settings-form" class="settings-form">
        <!-- Tabs -->
        <div class="settings-tabs">
            <button type="button" class="tab-btn active" data-tab="general">General</button>
            <button type="button" class="tab-btn" data-tab="sleeper">Sleeper Detection</button>
            <button type="button" class="tab-btn" data-tab="orderblock">Order Blocks</button>
            <button type="button" class="tab-btn" data-tab="trading">Trading</button>
            <button type="button" class="tab-btn" data-tab="notifications">Notifications</button>
        </div>

        <!-- General Tab -->
        <div class="tab-content active" id="tab-general">
            <div class="settings-section">
                <h2>üéÆ Execution Mode</h2>
                
                <div class="form-group">
                    <label for="execution_mode">Mode</label>
                    <select id="execution_mode" name="execution_mode" class="form-control">
                        {% for mode in execution_modes %}
                        <option value="{{ mode }}" {% if settings.execution_mode == mode %}selected{% endif %}>
                            {{ mode }}
                        </option>
                        {% endfor %}
                    </select>
                    <small>MANUAL = alerts only | SEMI_AUTO = confirm trades | AUTO = automatic</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="paper_trading" name="paper_trading" 
                                   {% if settings.paper_trading %}checked{% endif %}>
                            üìù Paper Trading Mode
                        </label>
                        <small>Simulate trades without real money</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="paper_balance">Paper Balance ($)</label>
                        <input type="number" id="paper_balance" name="paper_balance" 
                               value="{{ settings.paper_balance | default(10000) }}" step="100" class="form-control">
                    </div>
                </div>
            </div>
        </div>

        <!-- Sleeper Detection Tab -->
        <div class="tab-content" id="tab-sleeper">
            <div class="settings-section">
                <h2>üéØ Score Thresholds</h2>
                <p class="section-desc">Configure minimum scores for each sleeper state</p>
                
                <div class="form-row three-col">
                    <div class="form-group">
                        <label for="sleeper_min_score">Min Score (WATCHING)</label>
                        <input type="number" id="sleeper_min_score" name="sleeper_min_score" 
                               value="{{ settings.sleeper_min_score | default(40) }}" step="5" min="0" max="100" class="form-control">
                        <small>Minimum to track symbol</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="sleeper_building_score">Building Score</label>
                        <input type="number" id="sleeper_building_score" name="sleeper_building_score" 
                               value="{{ settings.sleeper_building_score | default(55) }}" step="5" min="0" max="100" class="form-control">
                        <small>Score for BUILDING state</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="sleeper_ready_score">Ready Score</label>
                        <input type="number" id="sleeper_ready_score" name="sleeper_ready_score" 
                               value="{{ settings.sleeper_ready_score | default(70) }}" step="5" min="0" max="100" class="form-control">
                        <small>Score for READY state üî•</small>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2>üîç Scan Parameters</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="sleeper_scan_limit">Max Symbols to Scan</label>
                        <input type="number" id="sleeper_scan_limit" name="sleeper_scan_limit" 
                               value="{{ settings.sleeper_scan_limit | default(100) }}" min="10" max="500" class="form-control">
                        <small>Top N by volume</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="sleeper_min_volume">Min 24h Volume ($M)</label>
                        <input type="number" id="sleeper_min_volume" name="sleeper_min_volume" 
                               value="{{ (settings.sleeper_min_volume | default(20000000)) / 1000000 }}" step="1" class="form-control">
                        <small>In millions (e.g. 20 = $20M)</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="sleeper_timeframe">Primary Timeframe</label>
                    <select id="sleeper_timeframe" name="sleeper_timeframe" class="form-control">
                        <option value="240" {% if settings.sleeper_timeframe == '240' or not settings.sleeper_timeframe %}selected{% endif %}>4H (recommended)</option>
                        <option value="60" {% if settings.sleeper_timeframe == '60' %}selected{% endif %}>1H</option>
                        <option value="D" {% if settings.sleeper_timeframe == 'D' %}selected{% endif %}>Daily</option>
                    </select>
                </div>
            </div>

            <div class="settings-section">
                <h2>‚öñÔ∏è Score Weights</h2>
                <p class="section-desc">Adjust importance of each factor (must sum to 100%)</p>
                
                <div class="form-row four-col">
                    <div class="form-group">
                        <label for="weight_fuel">Fuel (%)</label>
                        <input type="number" id="weight_fuel" name="weight_fuel" 
                               value="{{ settings.weight_fuel | default(30) }}" step="5" min="0" max="100" class="form-control">
                        <small>Funding + OI</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="weight_volatility">Volatility (%)</label>
                        <input type="number" id="weight_volatility" name="weight_volatility" 
                               value="{{ settings.weight_volatility | default(25) }}" step="5" min="0" max="100" class="form-control">
                        <small>BB Squeeze</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="weight_price">Price (%)</label>
                        <input type="number" id="weight_price" name="weight_price" 
                               value="{{ settings.weight_price | default(25) }}" step="5" min="0" max="100" class="form-control">
                        <small>Range position</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="weight_liquidity">Liquidity (%)</label>
                        <input type="number" id="weight_liquidity" name="weight_liquidity" 
                               value="{{ settings.weight_liquidity | default(20) }}" step="5" min="0" max="100" class="form-control">
                        <small>Volume profile</small>
                    </div>
                </div>
                <div class="weight-total" id="weight-total">Total: <span id="weight-total-value">100</span>%</div>
            </div>
        </div>

        <!-- Order Block Tab -->
        <div class="tab-content" id="tab-orderblock">
            <div class="settings-section">
                <h2>üì¶ Order Block Detection (Pine Script)</h2>
                <p class="section-desc">Parameters matching "Volumized Order Blocks | SVV Charts" indicator</p>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="ob_swing_length">Swing Length</label>
                        <input type="number" id="ob_swing_length" name="ob_swing_length" 
                               value="{{ settings.ob_swing_length | default(5) }}" min="3" max="20" class="form-control">
                        <small>Bars to find swing highs/lows (default: 5)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="ob_max_atr_mult">Max ATR Multiplier</label>
                        <input type="number" id="ob_max_atr_mult" name="ob_max_atr_mult" 
                               value="{{ settings.ob_max_atr_mult | default(3.5) }}" step="0.5" min="1" max="10" class="form-control">
                        <small>Max OB size = ATR √ó this (default: 3.5)</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="ob_zone_count">Zone Count</label>
                        <select id="ob_zone_count" name="ob_zone_count" class="form-control">
                            <option value="One" {% if settings.ob_zone_count == 'One' %}selected{% endif %}>One (1 zone)</option>
                            <option value="Low" {% if settings.ob_zone_count == 'Low' or not settings.ob_zone_count %}selected{% endif %}>Low (3 zones)</option>
                            <option value="Medium" {% if settings.ob_zone_count == 'Medium' %}selected{% endif %}>Medium (5 zones)</option>
                            <option value="High" {% if settings.ob_zone_count == 'High' %}selected{% endif %}>High (10 zones)</option>
                        </select>
                        <small>Number of OB zones to track</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="ob_end_method">Zone Invalidation</label>
                        <select id="ob_end_method" name="ob_end_method" class="form-control">
                            <option value="Wick" {% if settings.ob_end_method == 'Wick' or not settings.ob_end_method %}selected{% endif %}>Wick (high/low)</option>
                            <option value="Close" {% if settings.ob_end_method == 'Close' %}selected{% endif %}>Close (candle close)</option>
                        </select>
                        <small>How OB is invalidated</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="ob_max_count">Max Order Blocks</label>
                        <input type="number" id="ob_max_count" name="ob_max_count" 
                               value="{{ settings.ob_max_count | default(30) }}" min="5" max="100" class="form-control">
                        <small>Maximum OBs to store (default: 30)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="ob_timeframes">Scan Timeframes</label>
                        <input type="text" id="ob_timeframes" name="ob_timeframes" 
                               value="{{ settings.ob_timeframes | default('15,5') }}" class="form-control">
                        <small>Minutes, comma-separated (e.g. 15,5,1)</small>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2>üéØ Quality Filters</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="ob_min_quality">Min Quality Score</label>
                        <input type="number" id="ob_min_quality" name="ob_min_quality" 
                               value="{{ settings.ob_min_quality | default(60) }}" min="0" max="100" class="form-control">
                        <small>Minimum OB quality to track</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="ob_signal_quality">Signal Quality</label>
                        <input type="number" id="ob_signal_quality" name="ob_signal_quality" 
                               value="{{ settings.ob_signal_quality | default(70) }}" min="0" max="100" class="form-control">
                        <small>Min quality to generate signal</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Tab -->
        <div class="tab-content" id="tab-trading">
            <div class="settings-section">
                <h2>üí∞ Position Sizing</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="risk_per_trade">Risk per Trade (%)</label>
                        <input type="number" id="risk_per_trade" name="risk_per_trade" 
                               value="{{ settings.risk_per_trade | default(1) }}" step="0.1" min="0.1" max="10" class="form-control">
                        <small>% of balance to risk</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="max_position_pct">Max Position Size (%)</label>
                        <input type="number" id="max_position_pct" name="max_position_pct" 
                               value="{{ settings.max_position_pct | default(20) }}" step="1" min="1" max="100" class="form-control">
                        <small>Max % of balance per trade</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="default_leverage">Default Leverage</label>
                        <input type="number" id="default_leverage" name="default_leverage" 
                               value="{{ settings.default_leverage | default(5) }}" min="1" max="50" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="max_positions">Max Open Positions</label>
                        <input type="number" id="max_positions" name="max_positions" 
                               value="{{ settings.max_positions | default(3) }}" min="1" max="20" class="form-control">
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2>üéØ Stop Loss & Take Profit</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="atr_sl_multiplier">SL ATR Multiplier</label>
                        <input type="number" id="atr_sl_multiplier" name="atr_sl_multiplier" 
                               value="{{ settings.atr_sl_multiplier | default(1.5) }}" step="0.1" min="0.5" max="5" class="form-control">
                        <small>Stop Loss = ATR √ó this</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="atr_tp_multiplier">TP ATR Multiplier</label>
                        <input type="number" id="atr_tp_multiplier" name="atr_tp_multiplier" 
                               value="{{ settings.atr_tp_multiplier | default(3) }}" step="0.1" min="1" max="10" class="form-control">
                        <small>Take Profit = ATR √ó this</small>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="trailing_stop_enabled" name="trailing_stop_enabled" 
                               {% if settings.trailing_stop_enabled | default(true) %}checked{% endif %}>
                        üìà Enable Trailing Stop
                    </label>
                    <small>Move SL to breakeven after TP1</small>
                </div>
                
                <div class="form-row three-col">
                    <div class="form-group">
                        <label for="tp1_pct">TP1 Close (%)</label>
                        <input type="number" id="tp1_pct" name="tp1_pct" 
                               value="{{ settings.tp1_pct | default(50) }}" min="0" max="100" class="form-control">
                        <small>Close at 1R</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="tp2_pct">TP2 Close (%)</label>
                        <input type="number" id="tp2_pct" name="tp2_pct" 
                               value="{{ settings.tp2_pct | default(25) }}" min="0" max="100" class="form-control">
                        <small>Close at 2R</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="tp3_pct">TP3 Close (%)</label>
                        <input type="number" id="tp3_pct" name="tp3_pct" 
                               value="{{ settings.tp3_pct | default(25) }}" min="0" max="100" class="form-control">
                        <small>Close at 3R</small>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h2>‚ö†Ô∏è Risk Limits</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="max_daily_loss_pct">Max Daily Loss (%)</label>
                        <input type="number" id="max_daily_loss_pct" name="max_daily_loss_pct" 
                               value="{{ settings.max_daily_loss_pct | default(5) }}" step="0.5" min="1" max="20" class="form-control">
                        <small>Stop trading after this loss</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="max_daily_trades">Max Daily Trades</label>
                        <input type="number" id="max_daily_trades" name="max_daily_trades" 
                               value="{{ settings.max_daily_trades | default(10) }}" min="1" max="50" class="form-control">
                        <small>Limit overtrading</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Tab -->
        <div class="tab-content" id="tab-notifications">
            <div class="settings-section">
                <h2>üì± Telegram</h2>
                
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="telegram_enabled" name="telegram_enabled" 
                               {% if settings.telegram_enabled %}checked{% endif %}>
                        Enable Telegram Notifications
                    </label>
                </div>
                
                <div class="form-group">
                    <label for="telegram_chat_id">Chat ID</label>
                    <input type="text" id="telegram_chat_id" name="telegram_chat_id" 
                           value="{{ settings.telegram_chat_id or '' }}" class="form-control">
                    <small>Get from @userinfobot on Telegram</small>
                </div>
                
                <h3>Notify on:</h3>
                <div class="checkbox-grid">
                    <label class="checkbox-label">
                        <input type="checkbox" id="notify_sleeper_ready" name="notify_sleeper_ready" 
                               {% if settings.notify_sleeper_ready | default(true) %}checked{% endif %}>
                        Sleeper Ready
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="notify_ob_formed" name="notify_ob_formed" 
                               {% if settings.notify_ob_formed | default(true) %}checked{% endif %}>
                        Order Block Formed
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="notify_signal" name="notify_signal" 
                               {% if settings.notify_signal | default(true) %}checked{% endif %}>
                        Trade Signal
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="notify_trade_closed" name="notify_trade_closed" 
                               {% if settings.notify_trade_closed | default(true) %}checked{% endif %}>
                        Trade Closed
                    </label>
                </div>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">üíæ Save All Settings</button>
        </div>
    </form>
</div>

<style>
.settings-page { max-width: 900px; margin: 0 auto; }
.page-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }

.settings-tabs {
    display: flex;
    gap: 5px;
    border-bottom: 2px solid var(--border);
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.tab-btn {
    padding: 10px 15px;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-size: 0.9rem;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
}

.tab-btn:hover { color: var(--text-primary); }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

.tab-content { display: none; animation: fadeIn 0.3s ease; }
.tab-content.active { display: block; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.settings-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
}

.settings-section h2 { margin: 0 0 15px 0; font-size: 1.1rem; }
.settings-section h3 { margin: 15px 0 10px 0; font-size: 0.95rem; color: var(--text-secondary); }
.section-desc { color: var(--text-secondary); font-size: 0.85rem; margin: -10px 0 15px 0; }

.form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
.form-row.three-col { grid-template-columns: repeat(3, 1fr); }
.form-row.four-col { grid-template-columns: repeat(4, 1fr); }

@media (max-width: 700px) {
    .form-row, .form-row.three-col, .form-row.four-col { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 500px) {
    .form-row, .form-row.three-col, .form-row.four-col { grid-template-columns: 1fr; }
}

.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
.form-group small { display: block; margin-top: 4px; color: var(--text-secondary); font-size: 0.8rem; }

.form-control {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-size: 0.95rem;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
}

.checkbox-label { display: flex; align-items: center; gap: 8px; cursor: pointer; }
.checkbox-label input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

.checkbox-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }

.weight-total {
    margin-top: 10px;
    padding: 8px 12px;
    background: rgba(52, 199, 89, 0.1);
    border-radius: 6px;
    font-weight: bold;
    text-align: center;
}
.weight-total.error { background: rgba(255, 59, 48, 0.1); color: var(--danger); }

.form-actions { margin-top: 30px; text-align: center; }
.btn-lg { padding: 15px 40px; font-size: 1.1rem; }
</style>

<script>
// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    });
});

// Weight validation
function updateWeightTotal() {
    const fuel = parseInt(document.getElementById('weight_fuel').value) || 0;
    const vol = parseInt(document.getElementById('weight_volatility').value) || 0;
    const price = parseInt(document.getElementById('weight_price').value) || 0;
    const liq = parseInt(document.getElementById('weight_liquidity').value) || 0;
    const total = fuel + vol + price + liq;
    
    const el = document.getElementById('weight-total');
    document.getElementById('weight-total-value').textContent = total;
    el.classList.toggle('error', total !== 100);
}

['weight_fuel', 'weight_volatility', 'weight_price', 'weight_liquidity'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('input', updateWeightTotal);
});
updateWeightTotal();

// Form submission
document.getElementById('settings-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const settings = {};
    
    // Collect all inputs
    form.querySelectorAll('input, select').forEach(input => {
        const name = input.name;
        if (!name) return;
        
        if (input.type === 'checkbox') {
            settings[name] = input.checked;
        } else if (input.type === 'number') {
            settings[name] = parseFloat(input.value) || 0;
        } else {
            settings[name] = input.value;
        }
    });
    
    // Convert volume from M to actual
    if (settings.sleeper_min_volume) {
        settings.sleeper_min_volume = settings.sleeper_min_volume * 1000000;
    }
    
    // Validate weights
    const weightTotal = (settings.weight_fuel || 0) + (settings.weight_volatility || 0) + 
                       (settings.weight_price || 0) + (settings.weight_liquidity || 0);
    if (weightTotal !== 100) {
        alert('‚ö†Ô∏è Score weights must sum to 100%!');
        return;
    }
    
    try {
        const res = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        const data = await res.json();
        
        if (data.success) {
            showToast('‚úÖ Settings saved!');
        } else {
            alert('‚ùå Failed: ' + data.error);
        }
    } catch (err) {
        alert('‚ùå Error: ' + err.message);
    }
});

function resetDefaults() {
    if (!confirm('Reset all settings to defaults? This cannot be undone.')) return;
    
    fetch('/api/settings/reset', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('Settings reset to defaults');
                location.reload();
            }
        })
        .catch(err => alert('Error: ' + err.message));
}

function showToast(msg) {
    const toast = document.createElement('div');
    toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 24px;border-radius:8px;z-index:9999;';
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}
