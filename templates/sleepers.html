{% extends "base.html" %}
{% block title %}Sleepers - Sleeper OB Bot{% endblock %}

{% block content %}
<div class="page">
    <div class="page-header">
        <h1>ğŸ¯ Sleeper Candidates</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="clearBadSleepers()" title="Remove sleepers with missing data">ğŸ§¹ Clear Bad</button>
            <button class="btn btn-danger" onclick="clearAllSleepers()" title="Remove ALL sleepers">ğŸ—‘ï¸ Clear All</button>
            <button class="btn btn-primary" onclick="scanSleepersV3()">ğŸ” Scan v4.1</button>
        </div>
    </div>

    <div class="info-box">
        <strong>Sleeper Detector v4.1 (Direction Engine)</strong><br>
        Direction = HTF Bias (50%) + LTF Momentum (30%) + Derivatives (20%) | 
        ğŸŸ¢LONG â‰¥ +0.5 | ğŸ”´SHORT â‰¤ -0.5 | âšªWAIT = don't trade
    </div>

    {% if sleepers %}
    <table class="data-table sleepers-table">
        <thead>
            <tr>
                <th>Symbol</th>
                <th>State</th>
                <th>Dir</th>
                <th>Score</th>
                <th title="Volatility Compression 40%">VC</th>
                <th title="Volume Suppression 25%">VS</th>
                <th title="OI Growth 20%">OI</th>
                <th title="Order Book Imbalance 15%">OB</th>
                <th>HP</th>
                <th title="BB Compression %">BB%</th>
                <th title="Volume Ratio">Vol</th>
                <th>RSI</th>
                <th>Flags</th>
            </tr>
        </thead>
        <tbody>
            {% for s in sleepers %}
            <tr class="{% if s.state == 'READY' %}ready-row{% elif s.state == 'BUILDING' %}building-row{% elif s.state == 'TRIGGERED' %}triggered-row{% endif %}">
                <td class="symbol">
                    <a href="https://www.tradingview.com/chart/?symbol=BINANCE:{{ s.symbol }}.P" target="_blank">
                        {{ s.symbol }}
                    </a>
                </td>
                <td>
                    <span class="state-badge {{ s.state|lower }}">
                        {% if s.state == 'IDLE' %}âšª{% elif s.state == 'WATCHING' %}ğŸ‘€{% elif s.state == 'BUILDING' %}ğŸ”¨{% elif s.state == 'READY' %}ğŸ¯{% elif s.state == 'TRIGGERED' %}ğŸš€{% endif %}
                        {{ s.state }}
                    </span>
                </td>
                <td>
                    <span class="direction {{ s.direction|lower if s.direction else '' }} {% if s.direction_confidence == 'HIGH' %}high-conf{% elif s.direction_confidence == 'MEDIUM' %}mid-conf{% endif %}" 
                          title="Score: {{ '%.2f'|format(s.direction_score or 0) }} | {{ s.direction_confidence or 'LOW' }}">
                        {% if s.direction == 'LONG' %}ğŸŸ¢{% elif s.direction == 'SHORT' %}ğŸ”´{% else %}âšª{% endif %}
                        {% if s.direction != 'NEUTRAL' %}{{ '%.2f'|format(s.direction_score or 0) }}{% endif %}
                    </span>
                </td>
                <td class="score">
                    <div class="score-bar">
                        <div class="score-fill" style="width: {{ s.total_score or 0 }}%"></div>
                        <span class="score-value">{{ "%.0f"|format(s.total_score or 0) }}</span>
                    </div>
                </td>
                <td class="{% if (s.volatility_compression or 0) >= 80 %}high{% elif (s.volatility_compression or 0) >= 60 %}mid{% endif %}">
                    {{ "%.0f"|format(s.volatility_compression or s.volatility_score or 0) }}
                </td>
                <td class="{% if (s.volume_suppression or 0) >= 80 %}high{% elif (s.volume_suppression or 0) >= 60 %}mid{% endif %}">
                    {{ "%.0f"|format(s.volume_suppression or s.price_score or 0) }}
                </td>
                <td class="{% if (s.oi_growth or 0) >= 80 %}high{% elif (s.oi_growth or 0) >= 60 %}mid{% endif %}">
                    {{ "%.0f"|format(s.oi_growth or s.fuel_score or 0) }}
                </td>
                <td class="{% if (s.order_book_imbalance or 0) >= 80 %}high{% elif (s.order_book_imbalance or 0) >= 60 %}mid{% endif %}">
                    {{ "%.0f"|format(s.order_book_imbalance or s.liquidity_score or 0) }}
                </td>
                <td>
                    <span class="hp-badge {% if s.hp >= 7 %}high{% elif s.hp >= 4 %}mid{% else %}low{% endif %}">
                        {{ s.hp }}/10
                    </span>
                </td>
                <td class="{% if (s.bb_compression_pct or 0) >= 70 %}high{% elif (s.bb_compression_pct or 0) >= 50 %}mid{% endif %}">
                    {{ "%.0f"|format(s.bb_compression_pct or 0) }}%
                </td>
                <td class="{% if (s.volume_ratio or 1) <= 0.4 %}high{% elif (s.volume_ratio or 1) <= 0.6 %}mid{% elif (s.volume_ratio or 1) >= 2.0 %}warning{% endif %}">
                    {{ "%.2f"|format(s.volume_ratio or 1) }}x
                </td>
                <td class="{% if s.rsi and s.rsi > 70 %}overbought{% elif s.rsi and s.rsi < 30 %}oversold{% endif %}">
                    {{ "%.0f"|format(s.rsi or 50) }}
                </td>
                <td class="flags">
                    {% if s.vc_extreme_detected or s.vc_extreme %}ğŸ”¥{% endif %}
                    {% if s.adx_trendless %}ğŸ“Š{% endif %}
                    {% if s.price_at_poc %}ğŸ¯{% endif %}
                    {% if s.direction_confidence == 'HIGH' and s.direction != 'NEUTRAL' %}ğŸ’ª{% endif %}
                    {% if s.volume_spike_detected %}ğŸ“ˆ{% endif %}
                    {% if s.oi_jump_detected %}âš¡{% endif %}
                    {% if s.breakout_detected %}ğŸ†{% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ğŸ”</div>
        <div class="empty-text">No sleeper candidates found</div>
        <button class="btn btn-primary" onclick="scanSleepersV3()">Run Scan v4</button>
    </div>
    {% endif %}

    <div class="legend">
        <h3>5-Day Strategy Score (v4.0)</h3>
        <ul>
            <li><strong>VC - Volatility Compression (40%)</strong>: BB squeeze over 5 days. Higher = more compressed</li>
            <li><strong>VS - Volume Suppression (25%)</strong>: Volume decline vs 5-day average. Higher = quieter</li>
            <li><strong>OI - OI Growth (20%)</strong>: Open Interest accumulation. Higher = more positions building</li>
            <li><strong>OB - Order Book Imbalance (15%)</strong>: Bid/Ask imbalance. Higher = stronger directional pressure</li>
        </ul>
        
        <h3>v4 Bonuses</h3>
        <ul>
            <li><strong>ADX Bonus</strong>: ADX &lt; 20 = +10 pts, ADX falling = +15 pts (true sleeper confirmation)</li>
            <li><strong>POC Bonus</strong>: Price at POC = +8 pts, Strong POC = +12 pts (equilibrium zone)</li>
            <li><strong>Liquidity Filter</strong>: Min $50M 24h volume (slippage protection)</li>
        </ul>
        
        <h3>State Transitions</h3>
        <ul>
            <li>âšª <strong>IDLE</strong>: Not tracking</li>
            <li>ğŸ‘€ <strong>WATCHING</strong>: Score >40 OR VC >95%</li>
            <li>ğŸ”¨ <strong>BUILDING</strong>: 
                <br>â€¢ Classic: Score >55, VC >50%, VS >60%
                <br>â€¢ <span class="vc-extreme">Accelerated: VC >90% + OI growth >15%</span>
            </li>
            <li>ğŸ¯ <strong>READY</strong>: Score >65, VC >70% OR VC >95% + OI growth >20%</li>
            <li>ğŸš€ <strong>TRIGGERED</strong>: Volume spike >200% + OI jump >15%</li>
        </ul>
        
        <h3>Direction Engine v4.1</h3>
        <ul>
            <li><strong>3-Layer Model:</strong></li>
            <li>â€¢ HTF Structural Bias (50%): 1D structure + 4H EMA slope</li>
            <li>â€¢ LTF Momentum Shift (30%): RSI divergence + BB position</li>
            <li>â€¢ Derivatives Positioning (20%): OI + Funding + Price</li>
            <li><strong>Direction Score:</strong> -1.0 to +1.0 (shown next to emoji)</li>
            <li>ğŸŸ¢ LONG (score â‰¥ +0.5) | ğŸ”´ SHORT (score â‰¤ -0.5) | âšª NEUTRAL (wait)</li>
            <li><strong>READY + NEUTRAL = Don't trade</strong> (direction unclear)</li>
        </ul>
        
        <h3>Flags</h3>
        <ul>
            <li>ğŸ”¥ VC-EXTREME - Imminent breakout (VC >95% + VOL <1.2x)</li>
            <li>ğŸ“Š TRENDLESS - True sleeper (ADX <20)</li>
            <li>ğŸ¯ POC - Price at Point of Control (equilibrium)</li>
            <li>ğŸ’ª HIGH confidence direction</li>
            <li>ğŸ“ˆ Volume Spike (>200% of avg)</li>
            <li>âš¡ OI Jump (>15%)</li>
            <li>ğŸ† Breakout Detected</li>
        </ul>
        
        <h3>BTC Correlation</h3>
        <ul>
            <li>If BTC ADX >30 (trending) â†’ Altcoin sleepers may be less reliable</li>
            <li>If BTC volatility high â†’ Market-wide movement expected</li>
        </ul>
    </div>
</div>

<style>
.triggered-row { background: rgba(255, 215, 0, 0.2) !important; }
.building-row { background: rgba(255, 165, 0, 0.15) !important; }
.ready-row { background: rgba(0, 255, 0, 0.15) !important; }
.high { color: #00ff00; font-weight: bold; }
.mid { color: #ffaa00; }
.warning { color: #ff6600; }
.flags { font-size: 1.2em; }
.vc-extreme { color: #ff4500; font-weight: bold; }
.legend .vc-extreme { background: rgba(255, 69, 0, 0.1); padding: 2px 6px; border-radius: 4px; }
.trendless { color: #00bfff; font-weight: bold; }
.direction.high-conf { font-weight: bold; }
.direction.mid-conf { opacity: 0.9; }
.direction.long { color: #00ff00; }
.direction.short { color: #ff4444; }
.direction.neutral { color: #888; }
</style>

<script>
async function scanSleepersV3() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'â³ Scanning v4...';
    
    try {
        const res = await fetch('/api/scan/sleepers/v3', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            alert(`Scanned ${data.data.total} symbols. ${data.data.ready} ready, ${data.data.building} building.`);
            location.reload();
        } else {
            alert('Scan failed: ' + data.error);
        }
    } catch (err) {
        alert('Error: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ” Scan v3';
    }
}

async function clearBadSleepers() {
    if (!confirm('Remove sleepers with missing data?')) return;
    
    try {
        const res = await fetch('/api/sleepers/clear-bad', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            alert(`Removed ${data.removed} low-quality sleepers`);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function clearAllSleepers() {
    if (!confirm('âš ï¸ Remove ALL sleepers? This cannot be undone!')) return;
    
    try {
        const res = await fetch('/api/sleepers/clear-all', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            alert(`Cleared ${data.removed} sleepers`);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}
</script>
{% endblock %}
