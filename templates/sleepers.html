{% extends "base.html" %}
{% block title %}Sleepers - Sleeper OB Bot{% endblock %}

{% block content %}
<div class="page">
    <div class="page-header">
        <h1>ğŸ¯ Sleeper Candidates</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="clearBadSleepers()" title="Remove sleepers with missing data">ğŸ§¹ Clear Bad</button>
            <button class="btn btn-danger" onclick="clearAllSleepers()" title="Remove ALL sleepers">ğŸ—‘ï¸ Clear All</button>
            <button class="btn btn-primary" onclick="scanSleepersV3()">ğŸ” Scan v4.1</button>
        </div>
    </div>

    <div class="info-box">
        <strong>Sleeper Detector v4.1 (Direction Engine)</strong><br>
        Direction = HTF (50%) + LTF (30%) + Derivatives (20%) | 
        ğŸŸ¢LONG â‰¥ +0.3 | ğŸ”´SHORT â‰¤ -0.3 | âšªWAIT = don't trade
    </div>

    {% if sleepers %}
    <table class="data-table sleepers-table">
        <thead>
            <tr>
                <th>Symbol</th>
                <th>State</th>
                <th>Dir</th>
                <th>Score</th>
                <th title="Volatility Compression 40%">VC</th>
                <th title="Volume Suppression 25%">VS</th>
                <th title="OI Growth 20%">OI</th>
                <th title="Order Book Imbalance 15%">OB</th>
                <th>HP</th>
                <th title="BB Compression %">BB%</th>
                <th title="Volume Ratio">Vol</th>
                <th>RSI</th>
                <th>Flags</th>
            </tr>
        </thead>
        <tbody>
            {% for s in sleepers %}
            <tr class="{% if s.state == 'READY' %}ready-row{% elif s.state == 'BUILDING' %}building-row{% elif s.state == 'TRIGGERED' %}triggered-row{% endif %}">
                <td class="symbol">
                    <a href="https://www.tradingview.com/chart/?symbol=BINANCE:{{ s.symbol }}.P" target="_blank">
                        {{ s.symbol }}
                    </a>
                </td>
                <td>
                    <span class="state-badge {{ s.state|lower }}">
                        {% if s.state == 'IDLE' %}âšª{% elif s.state == 'WATCHING' %}ğŸ‘€{% elif s.state == 'BUILDING' %}ğŸ”¨{% elif s.state == 'READY' %}ğŸ¯{% elif s.state == 'TRIGGERED' %}ğŸš€{% endif %}
                        {{ s.state }}
                    </span>
                </td>
                <td>
                    <span class="direction {{ s.direction|lower if s.direction else '' }} {% if s.direction_confidence == 'HIGH' %}high-conf{% elif s.direction_confidence == 'MEDIUM' %}mid-conf{% endif %}" 
                          title="Score: {{ '%.2f'|format(s.direction_score or 0) }} | {{ s.direction_confidence or 'LOW' }}">
                        {% if s.direction == 'LONG' %}ğŸŸ¢{% elif s.direction == 'SHORT' %}ğŸ”´{% else %}âšª{% endif %}
                        {% if s.direction != 'NEUTRAL' %}{{ '%.2f'|format(s.direction_score or 0) }}{% endif %}
                    </span>
                </td>
                <td class="score">
                    <div class="score-bar">
                        <div class="score-fill" style="width: {{ s.total_score or 0 }}%"></div>
                        <span class="score-value">{{ "%.0f"|format(s.total_score or 0) }}</span>
                    </div>
                </td>
                <td class="{% if (s.volatility_compression or 0) >= 80 %}high{% elif (s.volatility_compression or 0) >= 60 %}mid{% endif %}">
                    {{ "%.0f"|format(s.volatility_compression or s.volatility_score or 0) }}
                </td>
                <td class="{% if (s.volume_suppression or 0) >= 80 %}high{% elif (s.volume_suppression or 0) >= 60 %}mid{% endif %}">
                    {{ "%.0f"|format(s.volume_suppression or s.price_score or 0) }}
                </td>
                <td class="{% if (s.oi_growth or 0) >= 80 %}high{% elif (s.oi_growth or 0) >= 60 %}mid{% endif %}">
                    {{ "%.0f"|format(s.oi_growth or s.fuel_score or 0) }}
                </td>
                <td class="{% if (s.order_book_imbalance or 0) >= 80 %}high{% elif (s.order_book_imbalance or 0) >= 60 %}mid{% endif %}">
                    {{ "%.0f"|format(s.order_book_imbalance or s.liquidity_score or 0) }}
                </td>
                <td>
                    <span class="hp-badge {% if s.hp >= 7 %}high{% elif s.hp >= 4 %}mid{% else %}low{% endif %}">
                        {{ s.hp }}/10
                    </span>
                </td>
                <td class="{% if (s.bb_compression_pct or 0) >= 70 %}high{% elif (s.bb_compression_pct or 0) >= 50 %}mid{% endif %}">
                    {{ "%.0f"|format(s.bb_compression_pct or 0) }}%
                </td>
                <td class="{% if (s.volume_ratio or 1) <= 0.4 %}high{% elif (s.volume_ratio or 1) <= 0.6 %}mid{% elif (s.volume_ratio or 1) >= 2.0 %}warning{% endif %}">
                    {{ "%.2f"|format(s.volume_ratio or 1) }}x
                </td>
                <td class="{% if s.rsi and s.rsi > 70 %}overbought{% elif s.rsi and s.rsi < 30 %}oversold{% endif %}">
                    {{ "%.0f"|format(s.rsi or 50) }}
                </td>
                <td class="flags">
                    {% if s.vc_extreme_detected or s.vc_extreme %}ğŸ”¥{% endif %}
                    {% if s.adx_trendless %}ğŸ“Š{% endif %}
                    {% if s.price_at_poc %}ğŸ¯{% endif %}
                    {% if s.direction_confidence == 'HIGH' and s.direction != 'NEUTRAL' %}ğŸ’ª{% endif %}
                    {% if s.volume_spike_detected %}ğŸ“ˆ{% endif %}
                    {% if s.oi_jump_detected %}âš¡{% endif %}
                    {% if s.breakout_detected %}ğŸ†{% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ğŸ”</div>
        <div class="empty-text">No sleeper candidates found</div>
        <button class="btn btn-primary" onclick="scanSleepersV3()">Run Scan v4</button>
    </div>
    {% endif %}

    <div class="legend">
        <details>
            <summary><h3>ğŸ“Š 5-Day Strategy Score</h3></summary>
            <ul>
                <li><strong>VC (40%)</strong>: BB squeeze over 5 days</li>
                <li><strong>VS (25%)</strong>: Volume decline vs average</li>
                <li><strong>OI (20%)</strong>: Open Interest accumulation</li>
                <li><strong>OB (15%)</strong>: Bid/Ask imbalance</li>
            </ul>
        </details>
        
        <details>
            <summary><h3>ğŸ v4 Bonuses</h3></summary>
            <ul>
                <li><strong>ADX</strong>: &lt;20 = +10pts, falling = +15pts</li>
                <li><strong>POC</strong>: At POC = +8pts, Strong = +12pts</li>
                <li><strong>Liquidity</strong>: Min $50M 24h volume</li>
            </ul>
        </details>
        
        <details>
            <summary><h3>ğŸ”„ State Transitions</h3></summary>
            <ul>
                <li>âšª IDLE: Not tracking</li>
                <li>ğŸ‘€ WATCHING: Score >40 OR VC >95%</li>
                <li>ğŸ”¨ BUILDING: Score >55 + VC >35% + VS >40%</li>
                <li>ğŸ”¨ BUILDING: Dir HIGH/MED + Score >65</li>
                <li>ğŸ¯ READY: Score >65 + VC >50%</li>
                <li>ğŸ¯ READY: Dir HIGH + Score >75</li>
                <li>ğŸš€ TRIGGERED: Volume >200% + OI >15%</li>
            </ul>
        </details>
        
        <details>
            <summary><h3>ğŸ§­ Direction Engine v4.1</h3></summary>
            <ul>
                <li>HTF Bias (50%): 1D structure + 4H EMA</li>
                <li>LTF Momentum (30%): RSI + BB position</li>
                <li>Derivatives (20%): OI + Funding</li>
                <li>ğŸŸ¢ LONG â‰¥ +0.3 | ğŸ”´ SHORT â‰¤ -0.3 | âšª WAIT</li>
                <li><strong>READY + WAIT = Don't trade</strong></li>
            </ul>
        </details>
        
        <details>
            <summary><h3>ğŸš© Flags</h3></summary>
            <ul>
                <li>ğŸ”¥ VC-EXTREME: Imminent breakout</li>
                <li>ğŸ“Š TRENDLESS: ADX &lt;20</li>
                <li>ğŸ¯ POC: At equilibrium</li>
                <li>ğŸ’ª HIGH confidence</li>
                <li>ğŸ“ˆ Volume Spike | âš¡ OI Jump</li>
            </ul>
        </details>
        
        <details>
            <summary><h3>â‚¿ BTC Correlation</h3></summary>
            <ul>
                <li>BTC ADX >30 â†’ Altcoin signals less reliable</li>
                <li>BTC volatile â†’ Market-wide movement</li>
            </ul>
        </details>
    </div>
</div>

<style>
.legend details { margin-bottom: 8px; }
.legend summary { cursor: pointer; user-select: none; }
.legend summary h3 { display: inline; margin: 0; font-size: 14px; }
.legend details[open] summary h3 { color: #00aaff; }
.legend ul { margin: 8px 0 0 20px; padding: 0; font-size: 13px; }
.legend li { margin: 4px 0; }
.triggered-row { background: rgba(255, 215, 0, 0.2) !important; }
.building-row { background: rgba(255, 165, 0, 0.15) !important; }
.ready-row { background: rgba(0, 255, 0, 0.15) !important; }
.high { color: #00ff00; font-weight: bold; }
.mid { color: #ffaa00; }
.warning { color: #ff6600; }
.flags { font-size: 1.2em; }
.vc-extreme { color: #ff4500; font-weight: bold; }
.trendless { color: #00bfff; font-weight: bold; }
.direction.high-conf { font-weight: bold; }
.direction.mid-conf { opacity: 0.9; }
.direction.long { color: #00ff00; }
.direction.short { color: #ff4444; }
.direction.neutral { color: #888; }
</style>

<script>
async function scanSleepersV3() {
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'â³ Scanning v4...';
    
    try {
        const res = await fetch('/api/scan/sleepers/v3', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            alert(`Scanned ${data.data.total} symbols. ${data.data.ready} ready, ${data.data.building} building.`);
            location.reload();
        } else {
            alert('Scan failed: ' + data.error);
        }
    } catch (err) {
        alert('Error: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ” Scan v3';
    }
}

async function clearBadSleepers() {
    if (!confirm('Remove sleepers with missing data?')) return;
    
    try {
        const res = await fetch('/api/sleepers/clear-bad', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            alert(`Removed ${data.removed} low-quality sleepers`);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}

async function clearAllSleepers() {
    if (!confirm('âš ï¸ Remove ALL sleepers? This cannot be undone!')) return;
    
    try {
        const res = await fetch('/api/sleepers/clear-all', { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            alert(`Cleared ${data.removed} sleepers`);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }
}
</script>
{% endblock %}
